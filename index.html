<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作戦ボード</title>
  <style>
    body {
      background: #e2eafc;
      font-family: sans-serif;
      margin: 0;
    }
    .main {
      display: flex;
      width: 100vw;
      height: 95vh;
      max-width: 1200px;
      min-height: 700px;
      margin: 0 auto;
    }
    .field-area {
      flex: 3;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .field {
      position: relative;
      width: 100%;
      max-width: 700px;
      aspect-ratio: 1/1.1;
      background: linear-gradient(135deg, #27ae60 70%, #145a32 100%);
      border: 4px solid #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px #0002;
      overflow: hidden;
    }
    .field .half-line {
      position: absolute;
      left: 0; right: 0;
      top: 25%;
      height: 0;
      border-top: 3px solid #fff;
      z-index: 1;
    }
    .field .center-semicircle {
      position: absolute;
      left: 50%;
      top: 25%;
      width: 120px;
      height: 60px;
      border-bottom: 3px solid #fff;
      border-radius: 0 0 60px 60px/0 0 60px 60px;
      transform: translateX(-50%);
      z-index: 2;
      background: none;
      pointer-events: none;
    }
    .field .goal-area {
      position: absolute;
      left: 50%;
      bottom: 0;
      width: 110px;
      height: 33px;
      border: 3px solid #fff;
      border-bottom: none;
      transform: translateX(-50%);
      z-index: 2;
      background: none;
    }
    .field .penalty-area {
      position: absolute;
      left: 50%;
      bottom: 0;
      width: 220px;
      height: 88px;
      border: 3px solid #fff;
      border-bottom: none;
      transform: translateX(-50%);
      z-index: 2;
      background: none;
    }
    .field .goal-line {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      border-top: 5px solid #fff;
      z-index: 2;
    }
    .field .goal {
      position: absolute;
      left: 50%;
      bottom: -10px;
      width: 44px;
      height: 10px;
      background: #fff;
      border-radius: 0 0 8px 8px;
      transform: translateX(-50%);
      z-index: 3;
    }
    .player {
      position: absolute;
      width: 70px;
      height: 80px;
      cursor: grab;
      user-select: none;
      z-index: 10;
      transition: transform .15s;
    }
    .player.dragging {
      opacity: 0.7;
      z-index: 99;
      transform: scale(1.08);
    }
    .player-circle {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(145deg, #3498db, #2980b9);
      border: 4px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2em;
      font-weight: bold;
      margin: 0 auto;
      box-shadow: 0 3px 10px #0005;
    }
    .player-name {
      text-align: center;
      font-size: 1.35em;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 3px #000b;
      margin-top: 4px;
    }
    .bench-area {
      flex: 1;
      background: #f8fafc;
      border-left: 3px solid #b3c6e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 18px 6px;
      min-width: 220px;
      overflow-y: auto;
    }
    .bench-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #277;
      margin-bottom: 12px;
    }
    .bench-list, .suspension-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .bench-player, .suspension-player {
      width: 90%;
      margin: 0 auto;
      background: #e3f0fc;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0001;
      padding: 7px 0 4px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: grab;
      transition: background .18s;
    }
    .bench-player.dragging, .suspension-player.dragging {
      opacity: 0.7;
      background: #b4e0fc;
    }
    .bench-player .player-circle, .suspension-player .player-circle {
      background: linear-gradient(145deg, #6c757d, #495057);
      border: 3px solid #fff;
      font-size: 1.5em;
    }
    .bench-player .player-name, .suspension-player .player-name {
      color: #333;
      font-size: 1.1em;
      text-shadow: none;
    }
    .suspension-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #a33;
      margin: 18px 0 8px 0;
      text-align: center;
    }
    .reset-btn {
      margin: 18px auto 0 auto;
      display: block;
      padding: 10px 18px;
      font-size: 1.1em;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background .18s;
    }
    .reset-btn:hover {
      background: #217dbb;
    }
    #edit-modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: #0008;
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    #edit-modal .modal-inner {
      background: #fff;
      padding: 24px 32px;
      border-radius: 12px;
      min-width: 300px;
      box-shadow: 0 6px 24px #0005;
    }
    #edit-modal label {
      display: block;
      margin-bottom: 8px;
    }
    #edit-modal input[type="text"],
    #edit-modal input[type="number"] {
      font-size: 1em;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #bbb;
      margin-left: 6px;
    }
    #edit-modal button {
      font-size: 1em;
      padding: 4px 14px;
      border-radius: 6px;
      border: none;
      background: #3498db;
      color: #fff;
      margin-left: 4px;
      cursor: pointer;
      transition: background .15s;
    }
    #edit-modal button:hover {
      background: #217dbb;
    }
    @media (max-width: 900px) {
      .main { flex-direction: column; }
      .field-area, .bench-area { width: 100%; min-width: unset; }
      .bench-area { border-left: none; border-top: 3px solid #b3c6e0; }
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="field-area">
      <div class="field" id="field">
        <div class="half-line"></div>
        <div class="center-semicircle"></div>
        <div class="goal-area"></div>
        <div class="penalty-area"></div>
        <div class="goal-line"></div>
        <div class="goal"></div>
        <!-- 選手はJSで描画 -->
      </div>
    </div>
    <div class="bench-area">
      <button class="reset-btn" onclick="movePlayersToFormation()">ピッチ内選手を初期配置に戻す</button>
      <div class="bench-title">控え選手</div>
      <div class="bench-list" id="bench"></div>
      <div class="suspension-title">出場停止</div>
      <div class="suspension-list" id="suspension"></div>
    </div>
  </div>
  <!-- 編集用モーダル -->
  <div id="edit-modal">
    <div class="modal-inner">
      <h3>選手情報の編集</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-id">
        <label>名前: <input type="text" id="edit-name" required></label>
        <label>背番号: <input type="number" id="edit-number" required style="width:60px;"></label>
        <label>ポジション: <input type="text" id="edit-positions" placeholder="カンマ区切り"></label>
        <div style="text-align:right; margin-top:12px;">
          <button type="button" onclick="closeEditModal()" style="margin-right:8px;">キャンセル</button>
          <button type="submit">保存</button>
        </div>
      </form>
    </div>
  </div>
<script>
const PLAYERS = [
  { id: 1, name: '坂本', number: 1, positions: ['GK'] },
  { id: 6, name: '神門', number: 2, positions: ['RB','CM'] },
  { id: 5, name: '伊藤', number: 3, positions: ['RB','LB'] },
  { id: 19, name: '杉野', number: 4, positions: ['CAM'] },
  { id: 7, name: '林', number: 5, positions: ['LB'] },
  { id: 20, name: '西川', number: 6, positions: ['CDM'] },
  { id: 2, name: '木下', number: 8, positions: ['RW'] },
  { id: 9, name: '大原', number: 9, positions: ['CAM'] },
  { id: 18, name: '中曽', number: 10, positions: ['LW'] },
  { id: 10, name: '高芝 Ⓤ', number: 11, positions: ['ST'] },
  { id: 8, name: '田中 Ⓤ', number: 16, positions: ['ST'] },
  { id: 3, name: '荒井 Ⓤ', number: 17, positions: ['LB'] },
  { id: 11, name: '飯田', number: 47, positions: ['ST'] },
  { id: 4, name: '辻', number: 22, positions: ['CB'] },
  { id: 16, name: '齊藤', number: 19, positions: ['ST'] },
  { id: 12, name: '峯', number: 12, positions: ['GK'] },
  { id: 13, name: '福島', number: 13, positions: ['CB'] },
  { id: 14, name: '井原', number: 14, positions: ['CM'] },
  { id: 17, name: '平田', number: 7, positions: ['CDM'] },
  { id: 15, name: '有田 Ⓤ', number: 15, positions: ['CDM'] },
  { id: 21, name: '芝本ｻｲﾄﾞ Ⓤ', number: 88, positions: ['CDM'] },
  { id: 22, name: '田中ﾎﾞﾗﾝﾁ Ⓤ', number: 88, positions: ['CDM'] },
  { id: 23, name: '助っ人', number: 88, positions: ['CDM'] }
];

// デフォルトで出場停止にしたい選手ID
const DEFAULT_SUSPENSIONS = [23, 18,20,17];

// 4-2-3-1 ハーフピッチ用初期配置（%: x=横, y=縦）
const FORMATION_4231 = [
  { id: 1, x: 50, y: 90 },   // GK
  { id: 2, x: 22, y: 75 },   // RB
  { id: 3, x: 38, y: 75 },   // CB
  { id: 4, x: 62, y: 75 },   // CB
  { id: 5, x: 78, y: 75 },   // LB
  { id: 6, x: 38, y: 52 },   // CDM
  { id: 7, x: 62, y: 52 },   // CDM
  { id: 8, x: 22, y: 35 },   // RW
  { id: 9, x: 50, y: 35 },   // CAM
  { id: 10, x: 78, y: 35 },  // LW
  { id: 11, x: 50, y: 18 }   // ST
];

let playersOnField = [...FORMATION_4231.map(p=>p.id)];
let playerPositions = {};
FORMATION_4231.forEach(p => playerPositions[p.id] = {x: p.x, y: p.y});
let suspensionPlayers = [...DEFAULT_SUSPENSIONS];

// 編集モーダル関連
function openEditModal(pid) {
  const p = PLAYERS.find(x => x.id === pid);
  document.getElementById('edit-id').value = p.id;
  document.getElementById('edit-name').value = p.name;
  document.getElementById('edit-number').value = p.number;
  document.getElementById('edit-positions').value = p.positions.join(',');
  document.getElementById('edit-modal').style.display = 'flex';
}
function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
}
document.getElementById('edit-form').onsubmit = function(e) {
  e.preventDefault();
  const pid = +document.getElementById('edit-id').value;
  const p = PLAYERS.find(x => x.id === pid);
  p.name = document.getElementById('edit-name').value;
  p.number = +document.getElementById('edit-number').value;
  p.positions = document.getElementById('edit-positions').value.split(',').map(s => s.trim()).filter(Boolean);
  closeEditModal();
  render();
};

function render() {
  // フィールド側
  const field = document.getElementById('field');
  field.querySelectorAll('.player').forEach(e=>e.remove());
  const fw = field.clientWidth, fh = field.clientHeight;
  playersOnField.forEach(pid=>{
    const p = PLAYERS.find(x=>x.id===pid);
    const pos = playerPositions[pid];
    const div = document.createElement('div');
    div.className = 'player';
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', pid);
    div.style.left = (pos.x/100*fw-35)+'px';
    div.style.top = (pos.y/100*fh-40)+'px';
    div.innerHTML = `<div class="player-circle">${p.number}</div><div class="player-name">${p.name}</div>`;
    div.addEventListener('dragstart', onDragStartPlayer);
    div.addEventListener('dragend', onDragEndPlayer);
    div.addEventListener('touchstart', onTouchStartPlayer, {passive:false});
    field.appendChild(div);
  });

  // 控え側
  const bench = document.getElementById('bench');
  bench.innerHTML = '';
  PLAYERS.filter(p=>!playersOnField.includes(p.id) && !suspensionPlayers.includes(p.id)).forEach(p=>{
    const div = document.createElement('div');
    div.className = 'bench-player';
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', p.id);
    div.innerHTML = `<div class="player-circle">${p.number}</div>
      <div class="player-name" style="cursor:pointer; text-decoration:underline dotted;" onclick="openEditModal(${p.id})">${p.name}</div>`;
    div.addEventListener('dragstart', onDragStartBench);
    div.addEventListener('dragend', onDragEndBench);
    div.addEventListener('touchstart', onTouchStartBench, {passive:false});
    // 右クリックで出場停止
    div.addEventListener('contextmenu', e=>{
      e.preventDefault();
      moveToSuspension(p.id);
    });
    bench.appendChild(div);
  });

  // 出場停止
  const suspension = document.getElementById('suspension');
  suspension.innerHTML = '';
  PLAYERS.filter(p=>suspensionPlayers.includes(p.id)).forEach(p=>{
    const div = document.createElement('div');
    div.className = 'suspension-player';
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', p.id);
    div.innerHTML = `<div class="player-circle">${p.number}</div>
      <div class="player-name" style="cursor:pointer; text-decoration:underline dotted;" onclick="openEditModal(${p.id})">${p.name}</div>`;
    div.addEventListener('dragstart', onDragStartSuspension);
    div.addEventListener('dragend', onDragEndSuspension);
    div.addEventListener('touchstart', onTouchStartSuspension, {passive:false});
    // 右クリックで控えに戻す
    div.addEventListener('contextmenu', e=>{
      e.preventDefault();
      moveToBench(p.id);
    });
    suspension.appendChild(div);
  });
}

// ドラッグデータ
let dragPlayerId = null;
let dragFrom = null;

// フィールド上の選手ドラッグ
function onDragStartPlayer(e) {
  dragPlayerId = +this.getAttribute('data-id');
  dragFrom = 'field';
  this.classList.add('dragging');
  document.getElementById('field').addEventListener('dragover', onDragOverField);
  document.getElementById('field').addEventListener('drop', onDropField);
  document.getElementById('bench').addEventListener('dragover', onDragOverBench);
  document.getElementById('bench').addEventListener('drop', onDropBench);
  document.getElementById('suspension').addEventListener('dragover', onDragOverSuspension);
  document.getElementById('suspension').addEventListener('drop', onDropSuspension);
}
function onDragEndPlayer(e) {
  this.classList.remove('dragging');
  document.getElementById('field').removeEventListener('dragover', onDragOverField);
  document.getElementById('field').removeEventListener('drop', onDropField);
  document.getElementById('bench').removeEventListener('dragover', onDragOverBench);
  document.getElementById('bench').removeEventListener('drop', onDropBench);
  document.getElementById('suspension').removeEventListener('dragover', onDragOverSuspension);
  document.getElementById('suspension').removeEventListener('drop', onDropSuspension);
  dragPlayerId = null;
  dragFrom = null;
}

// 控え選手ドラッグ
function onDragStartBench(e) {
  dragPlayerId = +this.getAttribute('data-id');
  dragFrom = 'bench';
  this.classList.add('dragging');
  document.getElementById('field').addEventListener('dragover', onDragOverField);
  document.getElementById('field').addEventListener('drop', onDropField);
  document.getElementById('bench').addEventListener('dragover', onDragOverBench);
  document.getElementById('bench').addEventListener('drop', onDropBench);
  document.getElementById('suspension').addEventListener('dragover', onDragOverSuspension);
  document.getElementById('suspension').addEventListener('drop', onDropSuspension);
}
function onDragEndBench(e) {
  this.classList.remove('dragging');
  document.getElementById('field').removeEventListener('dragover', onDragOverField);
  document.getElementById('field').removeEventListener('drop', onDropField);
  document.getElementById('bench').removeEventListener('dragover', onDragOverBench);
  document.getElementById('bench').removeEventListener('drop', onDropBench);
  document.getElementById('suspension').removeEventListener('dragover', onDragOverSuspension);
  document.getElementById('suspension').removeEventListener('drop', onDropSuspension);
  dragPlayerId = null;
  dragFrom = null;
}

// 出場停止選手ドラッグ
function onDragStartSuspension(e) {
  dragPlayerId = +this.getAttribute('data-id');
  dragFrom = 'suspension';
  this.classList.add('dragging');
  document.getElementById('bench').addEventListener('dragover', onDragOverBench);
  document.getElementById('bench').addEventListener('drop', onDropBench);
}
function onDragEndSuspension(e) {
  this.classList.remove('dragging');
  document.getElementById('bench').removeEventListener('dragover', onDragOverBench);
  document.getElementById('bench').removeEventListener('drop', onDropBench);
  dragPlayerId = null;
  dragFrom = null;
}

// フィールドへのドロップ
function onDragOverField(e) { e.preventDefault(); }
function onDropField(e) {
  e.preventDefault();
  const field = document.getElementById('field');
  const fw = field.clientWidth, fh = field.clientHeight;
  if (dragFrom === 'bench' && playersOnField.length < 11) {
    playersOnField.push(dragPlayerId);
    let x = e.offsetX/fw*100, y = e.offsetY/fh*100;
    // GKは一番下
    const p = PLAYERS.find(x=>x.id===dragPlayerId);
    if (p.positions.includes('GK')) y = 95;
    playerPositions[dragPlayerId] = {x, y};
  } else if (dragFrom === 'field') {
    let x = e.offsetX/fw*100, y = e.offsetY/fh*100;
    playerPositions[dragPlayerId] = {x, y};
  }
  render();
}

// 控えエリアへのドロップ
function onDragOverBench(e) { e.preventDefault(); }
function onDropBench(e) {
  e.preventDefault();
  if (dragFrom === 'field') {
    playersOnField = playersOnField.filter(id=>id!==dragPlayerId);
    delete playerPositions[dragPlayerId];
  } else if (dragFrom === 'suspension') {
    suspensionPlayers = suspensionPlayers.filter(id=>id!==dragPlayerId);
  }
  render();
}

// 出場停止エリアへのドロップ
function onDragOverSuspension(e) { e.preventDefault(); }
function onDropSuspension(e) {
  e.preventDefault();
  if (dragFrom === 'bench') {
    suspensionPlayers.push(dragPlayerId);
  }
  render();
}

// タッチ操作
function onTouchStartPlayer(e) {
  e.preventDefault();
  const pid = +this.getAttribute('data-id');
  let offsetX = e.touches[0].clientX - this.getBoundingClientRect().left;
  let offsetY = e.touches[0].clientY - this.getBoundingClientRect().top;
  const move = (ev) => {
    let x = (ev.touches[0].clientX - document.getElementById('field').getBoundingClientRect().left - offsetX);
    let y = (ev.touches[0].clientY - document.getElementById('field').getBoundingClientRect().top - offsetY);
    this.style.left = Math.max(0, Math.min(x, document.getElementById('field').clientWidth-70))+'px';
    this.style.top = Math.max(0, Math.min(y, document.getElementById('field').clientHeight-80))+'px';
  };
  const up = (ev) => {
    let field = document.getElementById('field');
    let fw = field.clientWidth, fh = field.clientHeight;
    let left = parseInt(this.style.left), top = parseInt(this.style.top);
    playerPositions[pid] = {x: (left+35)/fw*100, y: (top+40)/fh*100};
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', up);
    render();
  };
  document.addEventListener('touchmove', move, {passive:false});
  document.addEventListener('touchend', up, {passive:false});
}
function onTouchStartBench(e) {
  e.preventDefault();
  const pid = +this.getAttribute('data-id');
  if (playersOnField.length >= 11) return;
  playersOnField.push(pid);
  playerPositions[pid] = {x: 50, y: 50};
  render();
}
function onTouchStartSuspension(e) {
  e.preventDefault();
  // 出場停止→控え
  const pid = +this.getAttribute('data-id');
  suspensionPlayers = suspensionPlayers.filter(id=>id!==pid);
  render();
}

// 右クリックで控え→出場停止
function moveToSuspension(pid) {
  if (!suspensionPlayers.includes(pid)) {
    suspensionPlayers.push(pid);
    render();
  }
}
// 右クリックで出場停止→控え
function moveToBench(pid) {
  suspensionPlayers = suspensionPlayers.filter(id=>id!==pid);
  render();
}

// ピッチ内選手を一番近い初期配置へ
function movePlayersToFormation() {
  // 各選手を一番近い初期配置位置へ移動
  let remainInit = FORMATION_4231.map(p=>({...p}));
  playersOnField.forEach(pid=>{
    // 最も近い未割当の初期配置を探す
    let minIdx = 0, minDist = 1e9;
    for(let i=0;i<remainInit.length;i++) {
      let d = Math.abs(remainInit[i].x - (playerPositions[pid]?.x??50)) + Math.abs(remainInit[i].y - (playerPositions[pid]?.y??50));
      if (d < minDist) { minDist = d; minIdx = i; }
    }
    playerPositions[pid] = {x: remainInit[minIdx].x, y: remainInit[minIdx].y};
    remainInit.splice(minIdx,1);
  });
  render();
}

window.addEventListener('resize', render);
render();
</script>
</body>
</html>
