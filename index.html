<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作戦ボード</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      background: #e2eafc;
      font-family: sans-serif;
      margin: 0;
    }
    .main {
      display: flex;
      width: 100vw;
      height: 95vh;
      max-width: 1200px;
      min-height: 700px;
      margin: 0 auto;
    }
    .field-area {
      flex: 3;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .field {
      position: relative;
      width: 100%;
      max-width: 700px;
      aspect-ratio: 1/1.1;
      background: linear-gradient(135deg, #27ae60 70%, #145a32 100%);
      border: 4px solid #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px #0002;
      overflow: hidden;
    }
    .field .half-line {
      position: absolute;
      left: 0; right: 0;
      top: 25%;
      height: 0;
      border-top: 3px solid #fff;
      z-index: 1;
    }
    .field .center-semicircle {
      position: absolute;
      left: 50%;
      top: 25%;
      width: 120px;
      height: 60px;
      border-bottom: 3px solid #fff;
      border-radius: 0 0 60px 60px/0 0 60px 60px;
      transform: translateX(-50%);
      z-index: 2;
      background: none;
      pointer-events: none;
    }
    .field .goal-area {
      position: absolute;
      left: 50%;
      bottom: 0;
      width: 110px;
      height: 33px;
      border: 3px solid #fff;
      border-bottom: none;
      transform: translateX(-50%);
      z-index: 2;
      background: none;
    }
    .field .penalty-area {
      position: absolute;
      left: 50%;
      bottom: 0;
      width: 220px;
      height: 88px;
      border: 3px solid #fff;
      border-bottom: none;
      transform: translateX(-50%);
      z-index: 2;
      background: none;
    }
    .field .goal-line {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 0;
      border-top: 5px solid #fff;
      z-index: 2;
    }
    .field .goal {
      position: absolute;
      left: 50%;
      bottom: -10px;
      width: 44px;
      height: 10px;
      background: #fff;
      border-radius: 0 0 8px 8px;
      transform: translateX(-50%);
      z-index: 3;
    }
    .player {
      position: absolute;
      width: 70px;
      height: 80px;
      cursor: grab;
      user-select: none;
      z-index: 10;
      transition: transform .15s;
    }
    .player.dragging {
      opacity: 0.7;
      z-index: 99;
      transform: scale(1.08);
    }
    .player-circle {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: linear-gradient(145deg, #3498db, #2980b9);
      border: 4px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 2em;
      font-weight: bold;
      margin: 0 auto;
      box-shadow: 0 3px 10px #0005;
    }
    .player-name {
      text-align: center;
      font-size: 2.0em;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 3px #000b;
      margin-top: 4px;
    }
    .bench-area {
      flex: 1;
      background: #f8fafc;
      border-left: 3px solid #b3c6e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 18px 6px;
      min-width: 220px;
      overflow-y: auto;
    }
    .bench-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #277;
      margin-bottom: 12px;
    }
    .bench-list, .suspension-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .bench-player, .suspension-player {
      width: 90%;
      margin: 0 auto;
      background: #e3f0fc;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0001;
      padding: 7px 0 4px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: grab;
      transition: background .18s;
    }
    .bench-player.dragging, .suspension-player.dragging {
      opacity: 0.7;
      background: #b4e0fc;
    }
    .bench-player .player-circle, .suspension-player .player-circle {
      background: linear-gradient(145deg, #6c757d, #495057);
      border: 3px solid #fff;
      font-size: 1.5em;
    }
    .bench-player .player-name, .suspension-player .player-name {
      color: #333;
      font-size: 1.4em;
      text-shadow: none;
    }
    .suspension-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #a33;
      margin: 18px 0 8px 0;
      text-align: center;
    }
    .reset-btn {
      margin: 18px auto 0 auto;
      display: block;
      padding: 10px 18px;
      font-size: 1.1em;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background .18s;
    }
    .reset-btn:hover {
      background: #217dbb;
    }
    #edit-modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: #0008;
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    #edit-modal .modal-inner {
      background: #fff;
      padding: 24px 32px;
      border-radius: 12px;
      min-width: 300px;
      box-shadow: 0 6px 24px #0005;
    }
    #edit-modal label {
      display: block;
      margin-bottom: 8px;
    }
    #edit-modal input[type="text"],
    #edit-modal input[type="number"] {
      font-size: 1em;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #bbb;
      margin-left: 6px;
    }
    #edit-modal button {
      font-size: 1em;
      padding: 4px 14px;
      border-radius: 6px;
      border: none;
      background: #3498db;
      color: #fff;
      margin-left: 4px;
      cursor: pointer;
      transition: background .15s;
    }
    #edit-modal button:hover {
      background: #217dbb;
    }
    #custom-menu {
      display:none;
      position:fixed;
      z-index:2000;
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 12px #0005;
      min-width:120px;
      font-size:1.1em;
      user-select: none;
      border: 1px solid #ccc;
    }
    #custom-menu div:hover {
      background: #e2eafc;
    }
    @media (max-width: 900px) {
      .main { flex-direction: column; height: auto; min-height: unset; }
      .field-area, .bench-area { width: 100%; min-width: unset; }
      .bench-area { border-left: none; border-top: 3px solid #b3c6e0; }
      .field { max-width: 98vw; }
    }
    @media (max-width: 600px) {
      .player { width: 48px; height: 56px; }
      .player-circle { width: 36px; height: 36px; font-size: 1.2em; }
      .player-name { font-size: 1.3em; }
      .bench-player .player-circle, .suspension-player .player-circle { font-size: 1em; }
      .bench-player, .suspension-player { padding: 3px 0 2px 0; }
      .bench-area { min-width: unset; padding: 8px 2px; }
      .reset-btn { font-size: 0.95em; padding: 7px 10px; }
    }
    .player,
    .player-circle,
    .player-name,
    .bench-player,
    .suspension-player {
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -webkit-touch-callout: none; /* ← これを追加 */
    }
  </style>
</head>
<body>
  <div class="main" id="main1">
    <div class="field-area">
      <div class="field" id="field1">
        <div class="half-line"></div>
        <div class="center-semicircle"></div>
        <div class="goal-area"></div>
        <div class="penalty-area"></div>
        <div class="goal-line"></div>
        <div class="goal"></div>
      </div>
    </div>
    <div class="bench-area">
      <button class="reset-btn" onclick="movePlayersToFormation(1)">ピッチ内選手を初期配置に戻す</button>
      <div class="bench-title">控え選手</div>
      <div class="bench-list" id="bench1"></div>
      <div class="suspension-title">出場停止</div>
      <div class="suspension-list" id="suspension1"></div>
    </div>
  </div>
  <div class="main" id="main2">
    <div class="field-area">
      <div class="field" id="field2">
        <div class="half-line"></div>
        <div class="center-semicircle"></div>
        <div class="goal-area"></div>
        <div class="penalty-area"></div>
        <div class="goal-line"></div>
        <div class="goal"></div>
      </div>
    </div>
    <div class="bench-area">
      <button class="reset-btn" onclick="movePlayersToFormation(2)">ピッチ内選手を初期配置に戻す</button>
      <button class="reset-btn" style="background:#2ecc71;margin-top:8px;" onclick="copyFromUpper()">↑上の状態をコピー</button>
      <div class="bench-title">控え選手</div>
      <div class="bench-list" id="bench2"></div>
      <div class="suspension-title">出場停止</div>
      <div class="suspension-list" id="suspension2"></div>
    </div>
  </div>
  <!-- UI部分 -->
  <div id="edit-modal">
    <div class="modal-inner">
      <h3>選手情報の編集</h3>
      <form id="edit-form">
        <input type="hidden" id="edit-id">
        <label>名前: <input type="text" id="edit-name" required></label>
        <label>背番号: <input type="number" id="edit-number" required style="width:60px;"></label>
        <label>ポジション: <input type="text" id="edit-positions" placeholder="カンマ区切り"></label>
        <div style="text-align:right; margin-top:12px;">
          <button type="button" onclick="closeEditModal()" style="margin-right:8px;">キャンセル</button>
          <button type="submit">保存</button>
        </div>
      </form>
    </div>
  </div>
  <div id="custom-menu" style="display:none; position:fixed; z-index:2000; background:#fff; border-radius:10px; box-shadow:0 2px 12px #0005; min-width:120px; font-size:1.1em;">
    <div id="menu-to-field" style="padding:12px; border-bottom:1px solid #eee; cursor:pointer;">フィールドへ</div>
    <div id="menu-to-bench" style="padding:12px; border-bottom:1px solid #eee; cursor:pointer;">控えへ</div>
    <div id="menu-to-suspension" style="padding:12px; border-bottom:1px solid #eee; cursor:pointer;">出場停止へ</div>
    <div id="menu-edit-player" style="padding:12px; cursor:pointer; color:#217dbb; font-weight:bold;">選手情報変更</div>
  </div>
  <script>
// データ定義
const PLAYERS = [
  { id: 1, name: '坂本', number: 1, positions: ['GK'] },
  { id: 6, name: '神門', number: 2, positions: ['RB','CM'] },
  { id: 5, name: '伊藤', number: 3, positions: ['RB','LB'] },
  { id: 19, name: '杉野', number: 4, positions: ['CAM'] },
  { id: 7, name: '林', number: 5, positions: ['LB'] },
  { id: 20, name: '西川', number: 6, positions: ['CDM'] },
  { id: 2, name: '木下', number: 8, positions: ['RW'] },
  { id: 9, name: '大原', number: 9, positions: ['CAM'] },
  { id: 18, name: '中曽', number: 10, positions: ['LW'] },
  { id: 10, name: '高芝 Ⓤ', number: 11, positions: ['ST'] },
  { id: 8, name: '田中 Ⓤ', number: 16, positions: ['ST'] },
  { id: 3, name: '荒井 Ⓤ', number: 17, positions: ['LB'] },
  { id: 11, name: '飯田', number: 47, positions: ['ST'] },
  { id: 4, name: '辻', number: 22, positions: ['CB'] },
  { id: 16, name: '齊藤', number: 19, positions: ['ST'] },
  { id: 12, name: '峯', number: 12, positions: ['GK'] },
  { id: 13, name: '福島', number: 13, positions: ['CB'] },
  { id: 14, name: '井原', number: 14, positions: ['CM'] },
  { id: 17, name: '平田', number: 7, positions: ['CDM'] },
  { id: 15, name: '有田 Ⓤ', number: 15, positions: ['CDM'] },
  { id: 21, name: '芝本ｻｲﾄﾞ Ⓤ', number: 88, positions: ['CDM'] },
  { id: 22, name: '田中ﾎﾞﾗﾝﾁ Ⓤ', number: 87, positions: ['CDM'] },
  { id: 23, name: '助っ人', number: 88, positions: ['CDM'] }
];

const DEFAULT_SUSPENSIONS = [23, 18,20,17,21];

const FORMATION_4231 = [
  { id: 1, x: 50, y: 90 },   // GK
  { id: 2, x: 17, y: 75 },   // RB
  { id: 3, x: 38, y: 75 },   // CB
  { id: 4, x: 62, y: 75 },   // CB
  { id: 5, x: 83, y: 75 },   // LB
  { id: 6, x: 38, y: 52 },   // CDM
  { id: 7, x: 62, y: 52 },   // CDM
  { id: 8, x: 22, y: 35 },   // RW
  { id: 9, x: 50, y: 35 },   // CAM
  { id: 10, x: 78, y: 35 },  // LW
  { id: 11, x: 50, y: 18 }   // ST
];

// 状態
let states = [
  {
    playersOnField: [...FORMATION_4231.map(p=>p.id)],
    playerPositions: (()=>{let o={};FORMATION_4231.forEach(p=>o[p.id]={x:p.x,y:p.y});return o;})(),
    suspensionPlayers: [...DEFAULT_SUSPENSIONS]
  },
  {
    playersOnField: [...FORMATION_4231.map(p=>p.id)],
    playerPositions: (()=>{let o={};FORMATION_4231.forEach(p=>o[p.id]={x:p.x,y:p.y});return o;})(),
    suspensionPlayers: [...DEFAULT_SUSPENSIONS]
  }
];

let customMenuTarget = null; // 選手IDとエリア情報を保持

// 編集モーダル関連
function openEditModal(pid) {
  const p = PLAYERS.find(x => x.id === pid);
  document.getElementById('edit-id').value = p.id;
  document.getElementById('edit-name').value = p.name;
  document.getElementById('edit-number').value = p.number;
  document.getElementById('edit-positions').value = p.positions.join(',');
  document.getElementById('edit-modal').style.display = 'flex';
}
function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
}
document.getElementById('edit-form').onsubmit = function(e) {
  e.preventDefault();
  const pid = +document.getElementById('edit-id').value;
  const p = PLAYERS.find(x => x.id === pid);
  p.name = document.getElementById('edit-name').value;
  p.number = +document.getElementById('edit-number').value;
  p.positions = document.getElementById('edit-positions').value.split(',').map(s => s.trim()).filter(Boolean);
  closeEditModal();
  renderAll();
};

// 描画
function render(idx) {
  const state = states[idx-1];
  const field = document.getElementById('field'+idx);
  field.querySelectorAll('.player').forEach(e=>e.remove());
  const fw = field.clientWidth, fh = field.clientHeight;
  state.playersOnField.forEach(pid=>{
    const p = PLAYERS.find(x=>x.id===pid);
    const pos = state.playerPositions[pid];
    const div = document.createElement('div');
    div.className = 'player';
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', pid);
    div.style.left = (pos.x/100*fw-35)+'px';
    div.style.top = (pos.y/100*fh-40)+'px';
    div.innerHTML = `<div class="player-circle">${p.number}</div><div class="player-name">${p.name}</div>`;
    if(idx===1) {
      div.querySelector('.player-name').style.cursor = "pointer";
      div.querySelector('.player-name').onclick = ()=>openEditModal(pid);
    }
    div.oncontextmenu = (e) => showCustomMenu(e, pid, 'field', idx);
    // 長押し対応
    let pressTimer;
    let moved = false;
    div.ontouchstart = (e) => {
      moved = false;
      pressTimer = setTimeout(() => {
        showCustomMenu(e.touches[0], pid, 'field', idx);
        pressTimer = null;
      }, 600);
    };
    div.ontouchmove = () => {
      moved = true;
      if (pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
      }
    };
    div.ontouchend = () => {
      if (pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
      }
    };
    field.appendChild(div);
  });

  // 控え側
  const bench = document.getElementById('bench'+idx);
  bench.innerHTML = '';
  PLAYERS.filter(p=>!state.playersOnField.includes(p.id) && !state.suspensionPlayers.includes(p.id)).forEach(p=>{
    const div = document.createElement('div');
    div.className = 'bench-player';
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', p.id);
    div.innerHTML = `<div class="player-circle">${p.number}</div>
      <div class="player-name"${idx===1?' style="cursor:pointer;"':''}${idx===1?` onclick="openEditModal(${p.id})"`:""}>${p.name}</div>`;
    div.oncontextmenu = (e) => showCustomMenu(e, p.id, 'bench', idx);
    // 長押し対応
    let pressTimer;
    div.ontouchstart = (e) => {
      pressTimer = setTimeout(() => showCustomMenu(e.touches[0], p.id, 'bench', idx), 600);
    };
    div.ontouchend = () => clearTimeout(pressTimer);
    bench.appendChild(div);
  });

  // 出場停止
  const suspension = document.getElementById('suspension'+idx);
  suspension.innerHTML = '';
  PLAYERS.filter(p=>state.suspensionPlayers.includes(p.id)).forEach(p=>{
    const div = document.createElement('div');
    div.className = 'suspension-player';
    div.setAttribute('draggable', true);
    div.setAttribute('data-id', p.id);
    div.innerHTML = `<div class="player-circle">${p.number}</div>
      <div class="player-name"${idx===1?' style="cursor:pointer;"':''}${idx===1?` onclick="openEditModal(${p.id})"`:""}>${p.name}</div>`;
    div.oncontextmenu = (e) => showCustomMenu(e, p.id, 'suspension', idx);
    // 長押し対応
    let pressTimer;
    div.ontouchstart = (e) => {
      pressTimer = setTimeout(() => showCustomMenu(e.touches[0], p.id, 'suspension', idx), 600);
    };
    div.ontouchend = () => clearTimeout(pressTimer);
    suspension.appendChild(div);
  });

  // ここを追加
  enableFieldDrag(idx);
}

// フィールド内ドラッグ移動対応
function enableFieldDrag(idx) {
  const field = document.getElementById('field'+idx);
  let draggingId = null;
  let touchMoveHandler = null;

  field.querySelectorAll('.player').forEach(div => {
    // PC用ドラッグ
    div.ondragstart = function(e) {
      draggingId = +div.getAttribute('data-id');
      div.classList.add('dragging');
      // ドラッグ画像を透明に
      const img = new Image();
      img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1' height='1'/%3E";
      e.dataTransfer.setDragImage(img, 0, 0);
    };
    div.ondragend = function() {
      draggingId = null;
      div.classList.remove('dragging');
    };

    // モバイル用タッチドラッグ
    div.ontouchstart = function(e) {
      if (e.touches.length !== 1) return;
      draggingId = +div.getAttribute('data-id');
      div.classList.add('dragging');
      const rect = field.getBoundingClientRect();
      const startX = e.touches[0].clientX;
      const startY = e.touches[0].clientY;
      const origX = parseFloat(div.style.left);
      const origY = parseFloat(div.style.top);

      touchMoveHandler = function(ev) {
        if (draggingId == null) return;
        ev.preventDefault(); // ← これを追加
        const moveX = ev.touches[0].clientX - startX;
        const moveY = ev.touches[0].clientY - startY;
        div.style.left = (origX + moveX) + "px";
        div.style.top = (origY + moveY) + "px";
      };
      document.addEventListener('touchmove', touchMoveHandler, {passive:false});
    };
    div.ontouchend = function(e) {
      if (draggingId == null) return;
      div.classList.remove('dragging');
      document.removeEventListener('touchmove', touchMoveHandler, {passive:false});
      // 最終位置を保存
      const rect = field.getBoundingClientRect();
      const left = parseFloat(div.style.left);
      const top = parseFloat(div.style.top);
      const fw = field.clientWidth, fh = field.clientHeight;
      // 逆算してx,y(%)を求める
      const x = ((left + 35) / fw) * 100;
      const y = ((top + 40) / fh) * 100;
      const state = states[idx-1];
      state.playerPositions[draggingId] = { x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) };
      draggingId = null;
      render(idx);
    };
  });

  field.ondragover = function(e) {
    e.preventDefault();
  };
  field.ondrop = function(e) {
    e.preventDefault();
    if (draggingId == null) return;
    const rect = field.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / field.clientWidth) * 100;
    const y = ((e.clientY - rect.top) / field.clientHeight) * 100;
    const state = states[idx-1];
    state.playerPositions[draggingId] = { x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) };
    render(idx);
  };
}

// 描画時にドラッグ有効化
function renderAll() {
  render(1);
  render(2);
  enableFieldDrag(1);
  enableFieldDrag(2);
}

function showCustomMenu(e, pid, area, idx) {
  e.preventDefault();
  customMenuTarget = { pid, area, idx };
  const menu = document.getElementById('custom-menu');
  menu.style.display = 'block';
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
}
function hideCustomMenu() {
  document.getElementById('custom-menu').style.display = 'none';
  customMenuTarget = null;
}
window.addEventListener('click', hideCustomMenu);
window.addEventListener('scroll', hideCustomMenu);

window.addEventListener('resize', renderAll);
renderAll();

document.getElementById('menu-to-field').onclick = function() {
  if (!customMenuTarget) return;
  const { pid, area, idx } = customMenuTarget;
  const state = states[idx-1];
  // 既にフィールドにいる場合は何もしない
  if (!state.playersOnField.includes(pid)) {
    // 控え・出場停止から除外
    state.suspensionPlayers = state.suspensionPlayers.filter(x=>x!==pid);
    // 11人未満なら追加
    if (state.playersOnField.length < 11) {
      state.playersOnField.push(pid);
      // 適当な位置に配置（中央）
      state.playerPositions[pid] = {x:50, y:50};
    }
  }
  hideCustomMenu();
  render(idx);
};
document.getElementById('menu-to-bench').onclick = function() {
  if (!customMenuTarget) return;
  const { pid, area, idx } = customMenuTarget;
  const state = states[idx-1];
  state.playersOnField = state.playersOnField.filter(x=>x!==pid);
  state.suspensionPlayers = state.suspensionPlayers.filter(x=>x!==pid);
  hideCustomMenu();
  render(idx);
};
document.getElementById('menu-to-suspension').onclick = function() {
  if (!customMenuTarget) return;
  const { pid, area, idx } = customMenuTarget;
  const state = states[idx-1];
  state.playersOnField = state.playersOnField.filter(x=>x!==pid);
  if (!state.suspensionPlayers.includes(pid)) state.suspensionPlayers.push(pid);
  hideCustomMenu();
  render(idx);
};
document.getElementById('menu-edit-player').onclick = function() {
  if (!customMenuTarget) return;
  openEditModal(customMenuTarget.pid);
  hideCustomMenu();
};

/**
 * ピッチ内選手を初期配置に一番近い位置へ移動
 * @param {number} idx 1 or 2
 */
function movePlayersToFormation(idx) {
  const state = states[idx-1];
  // 初期配置の座標リスト
  const formation = [...FORMATION_4231];
  // 現在フィールド上の選手IDリスト
  const fieldPlayers = [...state.playersOnField];

  // 初期配置と現在の選手をマッチング（最も近い位置に割り当て）
  // 1. 距離行列を作る
  const dist = [];
  for (let i = 0; i < fieldPlayers.length; i++) {
    dist[i] = [];
    for (let j = 0; j < formation.length; j++) {
      const pid = fieldPlayers[i];
      const pos = state.playerPositions[pid];
      const fpos = formation[j];
      dist[i][j] = Math.hypot((pos?.x ?? 50) - fpos.x, (pos?.y ?? 50) - fpos.y);
    }
  }
  // 2. 貪欲法で割り当て
  const usedFormation = new Set();
  const assign = {};
  for (let k = 0; k < Math.min(fieldPlayers.length, formation.length); k++) {
    let minI = -1, minJ = -1, minD = 1e9;
    for (let i = 0; i < fieldPlayers.length; i++) {
      if (assign[fieldPlayers[i]] !== undefined) continue;
      for (let j = 0; j < formation.length; j++) {
        if (usedFormation.has(j)) continue;
        if (dist[i][j] < minD) {
          minD = dist[i][j];
          minI = i;
          minJ = j;
        }
      }
    }
    if (minI !== -1 && minJ !== -1) {
      assign[fieldPlayers[minI]] = minJ;
      usedFormation.add(minJ);
    }
  }
  // 3. 割り当てた初期配置座標に移動
  for (const pid of fieldPlayers) {
    const j = assign[pid];
    if (j !== undefined) {
      state.playerPositions[pid] = { x: formation[j].x, y: formation[j].y };
    }
  }
  render(idx);
}
  </script>
</body>
</html>
