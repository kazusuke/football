// タッチ操作
function onTouchStartPlayer(e, idx) {
  e.preventDefault();
  let playerDiv = e.target.closest('.player');
  if (!playerDiv) return;
  const pid = +playerDiv.getAttribute('data-id');
  const field = document.getElementById('field'+idx);

  // フィールドと選手の現在のサイズ・位置を取得
  const fieldRect = field.getBoundingClientRect();
  const fw = field.clientWidth, fh = field.clientHeight;
  const pos = states[idx-1].playerPositions[pid];
  
  // 選手の現在位置（px、左上基準）
  let currentLeft = pos.x/100*fw - playerDiv.offsetWidth/2;
  let currentTop = pos.y/100*fh - playerDiv.offsetHeight/2;

  // タッチ開始時点の指の位置
  const startTouch = e.touches[0];
  const startX = startTouch.clientX;
  const startY = startTouch.clientY;
  
  // 選手の中心位置（絶対座標）
  const playerCenterX = fieldRect.left + pos.x/100*fw;
  const playerCenterY = fieldRect.top + pos.y/100*fh;
  
  // タッチ開始時の指と選手中心の差分
  const offsetX = startX - playerCenterX;
  const offsetY = startY - playerCenterY;

  const move = (ev) => {
    ev.preventDefault();
    const touch = ev.touches[0];
    
    // 新しい選手中心位置（絶対座標）
    const newCenterX = touch.clientX - offsetX;
    const newCenterY = touch.clientY - offsetY;
    
    // フィールド内での相対位置に変換
    const relativeX = newCenterX - fieldRect.left;
    const relativeY = newCenterY - fieldRect.top;
    
    // 選手の左上座標に変換（フィールド内制限付き）
    let x = relativeX - playerDiv.offsetWidth/2;
    let y = relativeY - playerDiv.offsetHeight/2;
    
    // フィールド境界内に制限
    x = Math.max(0, Math.min(x, fw - playerDiv.offsetWidth));
    y = Math.max(0, Math.min(y, fh - playerDiv.offsetHeight));
    
    playerDiv.style.left = x + 'px';
    playerDiv.style.top = y + 'px';
  };

  const up = (ev) => {
    const left = parseFloat(playerDiv.style.left) || currentLeft;
    const top = parseFloat(playerDiv.style.top) || currentTop;
    
    // 選手中心位置をパーセンテージで保存
    states[idx-1].playerPositions[pid] = {
      x: (left + playerDiv.offsetWidth/2) / fw * 100,
      y: (top + playerDiv.offsetHeight/2) / fh * 100
    };
    
    // スタイルをクリアして通常の描画に戻す
    playerDiv.style.left = '';
    playerDiv.style.top = '';
    
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', up);
    render(idx);
  };

  document.addEventListener('touchmove', move, {passive:false});
  document.addEventListener('touchend', up, {passive:false});
}
