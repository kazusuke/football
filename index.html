<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>戦術ボード - Tacticalista風</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #fff;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      max-width: 1200px;
      margin: auto;
    }
    @media (min-width: 900px) {
      .fields {
        flex-direction: row;
      }
    }
    .fields {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }
    .field-area {
      flex: 1;
      background: #2e7d32;
      border-radius: 16px;
      box-shadow: 0 2px 8px #0008;
      position: relative;
      min-height: 400px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .field-svg {
      width: 100%;
      height: 400px;
      display: block;
    }
    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .player-chip {
      background: #fff;
      color: #222;
      border-radius: 16px;
      padding: 0.3em 0.8em;
      font-size: 0.95em;
      cursor: grab;
      user-select: none;
      border: 2px solid #1976d2;
      margin-bottom: 0.2em;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .player-chip[data-status="bench"] {
      border-color: #888;
      background: #eee;
      color: #888;
    }
    .player-chip[data-status="suspended"] {
      border-color: #d32f2f;
      background: #ffcdd2;
      color: #b71c1c;
      text-decoration: line-through;
    }
    .player-dot {
      width: 1.6em;
      height: 1.6em;
      border-radius: 50%;
      background: #1976d2;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1em;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px #0004;
      cursor: grab;
      position: absolute;
      transition: box-shadow 0.2s;
      z-index: 2;
      touch-action: none;
    }
    .player-dot[data-status="bench"] {
      background: #888;
      color: #fff;
      border-color: #ccc;
      opacity: 0.7;
      cursor: not-allowed;
    }
    .player-dot[data-status="suspended"] {
      background: #d32f2f;
      color: #fff;
      border-color: #fff;
      opacity: 0.6;
      cursor: not-allowed;
      text-decoration: line-through;
    }
    .field-label {
      position: absolute;
      top: 8px;
      left: 16px;
      font-size: 1.1em;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 1px 4px #000a;
      z-index: 10;
    }
    .menu {
      position: absolute;
      background: #fff;
      color: #222;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0008;
      min-width: 120px;
      z-index: 1000;
      display: none;
      flex-direction: column;
      font-size: 1em;
      overflow: hidden;
    }
    .menu.active {
      display: flex;
    }
    .menu button {
      background: none;
      border: none;
      padding: 0.7em 1em;
      text-align: left;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
    }
    .menu button:hover {
      background: #1976d2;
      color: #fff;
    }
    @media (max-width: 700px) {
      .field-svg {
        height: 260px;
      }
      .field-area {
        min-height: 260px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>戦術ボード - Tacticalista風</h1>
    <div class="players-list" id="players-list"></div>
    <div class="fields">
      <div class="field-area" id="field1">
        <span class="field-label">フィールドA</span>
        <svg class="field-svg" viewBox="0 0 1000 600">
          <rect x="0" y="0" width="1000" height="600" rx="30" fill="#388e3c"/>
          <rect x="50" y="50" width="900" height="500" rx="20" fill="none" stroke="#fff" stroke-width="6"/>
          <rect x="50" y="200" width="120" height="200" fill="none" stroke="#fff" stroke-width="4"/>
          <rect x="830" y="200" width="120" height="200" fill="none" stroke="#fff" stroke-width="4"/>
          <circle cx="500" cy="300" r="80" fill="none" stroke="#fff" stroke-width="4"/>
          <line x1="500" y1="50" x2="500" y2="550" stroke="#fff" stroke-width="4"/>
          <circle cx="500" cy="300" r="8" fill="#fff"/>
        </svg>
      </div>
      <div class="field-area" id="field2">
        <span class="field-label">フィールドB</span>
        <svg class="field-svg" viewBox="0 0 1000 600">
          <rect x="0" y="0" width="1000" height="600" rx="30" fill="#388e3c"/>
          <rect x="50" y="50" width="900" height="500" rx="20" fill="none" stroke="#fff" stroke-width="6"/>
          <rect x="50" y="200" width="120" height="200" fill="none" stroke="#fff" stroke-width="4"/>
          <rect x="830" y="200" width="120" height="200" fill="none" stroke="#fff" stroke-width="4"/>
          <circle cx="500" cy="300" r="80" fill="none" stroke="#fff" stroke-width="4"/>
          <line x1="500" y1="50" x2="500" y2="550" stroke="#fff" stroke-width="4"/>
          <circle cx="500" cy="300" r="8" fill="#fff"/>
        </svg>
      </div>
    </div>
  </div>
  <div class="menu" id="context-menu">
    <button data-action="bench">控えにする</button>
    <button data-action="suspend">出場停止にする</button>
    <button data-action="field">フィールドに戻す</button>
  </div>
  <script>
    // 23人の選手データ（例: 実名・背番号・ポジション）
    const players = [
      { id: 1, name: "田中 太郎", number: 1, pos: "GK" },
      { id: 2, name: "佐藤 次郎", number: 2, pos: "RB" },
      { id: 3, name: "鈴木 三郎", number: 3, pos: "CB" },
      { id: 4, name: "高橋 四郎", number: 4, pos: "CB" },
      { id: 5, name: "伊藤 五郎", number: 5, pos: "LB" },
      { id: 6, name: "渡辺 六郎", number: 6, pos: "DMF" },
      { id: 7, name: "山本 七郎", number: 7, pos: "DMF" },
      { id: 8, name: "中村 八郎", number: 8, pos: "RMF" },
      { id: 9, name: "小林 九郎", number: 9, pos: "OMF" },
      { id: 10, name: "加藤 十郎", number: 10, pos: "LMF" },
      { id: 11, name: "吉田 十一", number: 11, pos: "CF" },
      { id: 12, name: "松本 十二", number: 12, pos: "控え" },
      { id: 13, name: "斎藤 十三", number: 13, pos: "控え" },
      { id: 14, name: "清水 十四", number: 14, pos: "控え" },
      { id: 15, name: "山田 十五", number: 15, pos: "控え" },
      { id: 16, name: "森田 十六", number: 16, pos: "控え" },
      { id: 17, name: "石井 十七", number: 17, pos: "控え" },
      { id: 18, name: "池田 十八", number: 18, pos: "控え" },
      { id: 19, name: "橋本 十九", number: 19, pos: "控え" },
      { id: 20, name: "阿部 二十", number: 20, pos: "控え" },
      { id: 21, name: "山口 二十一", number: 21, pos: "控え" },
      { id: 22, name: "松田 二十二", number: 22, pos: "控え" },
      { id: 23, name: "藤田 二十三", number: 23, pos: "控え" }
    ];

    // 4-2-3-1の初期配置（フィールド座標: 0-1000, 0-600）
    const formation_4231 = [
      // GK
      { id: 1, x: 100, y: 300 },
      // DF
      { id: 2, x: 250, y: 120 },
      { id: 3, x: 250, y: 240 },
      { id: 4, x: 250, y: 360 },
      { id: 5, x: 250, y: 480 },
      // DMF
      { id: 6, x: 400, y: 220 },
      { id: 7, x: 400, y: 380 },
      // MF
      { id: 8, x: 600, y: 120 },
      { id: 9, x: 600, y: 300 },
      { id: 10, x: 600, y: 480 },
      // FW
      { id: 11, x: 800, y: 300 }
    ];

    // 状態管理
    let playerStates = {};
    // 各フィールドごとに配置
    function initPlayerStates() {
      playerStates = {
        field1: {},
        field2: {},
        bench: [],
        suspended: []
      };
      // 4-2-3-1の11人をフィールド1, 残りを控え
      for (let i = 0; i < players.length; i++) {
        if (i < 11) {
          playerStates.field1[players[i].id] = {
            ...players[i],
            x: formation_4231[i].x,
            y: formation_4231[i].y,
            status: "field"
          };
        } else {
          playerStates.bench.push({ ...players[i], status: "bench" });
        }
      }
      // フィールド2は空
      playerStates.field2 = {};
      playerStates.suspended = [];
    }
    initPlayerStates();

    // 選手リスト描画
    function renderPlayersList() {
      const list = document.getElementById('players-list');
      list.innerHTML = '';
      // フィールド1
      Object.values(playerStates.field1).forEach(p => {
        list.appendChild(createPlayerChip(p, "field1"));
      });
      // フィールド2
      Object.values(playerStates.field2).forEach(p => {
        list.appendChild(createPlayerChip(p, "field2"));
      });
      // 控え
      playerStates.bench.forEach(p => {
        list.appendChild(createPlayerChip(p, "bench"));
      });
      // 出場停止
      playerStates.suspended.forEach(p => {
        list.appendChild(createPlayerChip(p, "suspended"));
      });
    }

    function createPlayerChip(player, location) {
      const chip = document.createElement('div');
      chip.className = 'player-chip';
      chip.draggable = true;
      chip.dataset.id = player.id;
      chip.dataset.status = player.status;
      chip.innerHTML = `<b>#${player.number}</b> ${player.name} <span style="font-size:0.9em;color:#1976d2;">[${player.pos}]</span>`;
      chip.addEventListener('contextmenu', e => {
        e.preventDefault();
        showContextMenu(e, player, location);
      });
      chip.addEventListener('touchstart', e => {
        chip._touchTimer = setTimeout(() => {
          showContextMenu(e, player, location, true);
        }, 600);
      });
      chip.addEventListener('touchend', e => {
        clearTimeout(chip._touchTimer);
      });
      chip.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ id: player.id, from: location }));
      });
      return chip;
    }

    // フィールド上の選手描画
    function renderFieldPlayers(fieldId) {
      const area = document.getElementById(fieldId);
      // 既存のplayer-dotを削除
      area.querySelectorAll('.player-dot').forEach(e => e.remove());
      const fieldPlayers = playerStates[fieldId];
      Object.values(fieldPlayers).forEach(player => {
        const dot = document.createElement('div');
        dot.className = 'player-dot';
        dot.dataset.id = player.id;
        dot.dataset.status = player.status;
        dot.style.left = `calc(${player.x / 10}% - 0.8em)`;
        dot.style.top = `calc(${player.y / 6}% - 0.8em)`;
        dot.innerHTML = `<span style="font-size:1em;">${player.number}</span>`;
        dot.title = `${player.name} [${player.pos}]`;
        dot.draggable = true;
        dot.addEventListener('contextmenu', e => {
          e.preventDefault();
          showContextMenu(e, player, fieldId);
        });
        dot.addEventListener('touchstart', e => {
          dot._touchTimer = setTimeout(() => {
            showContextMenu(e, player, fieldId, true);
          }, 600);
        });
        dot.addEventListener('touchend', e => {
          clearTimeout(dot._touchTimer);
        });
        dot.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', JSON.stringify({ id: player.id, from: fieldId }));
        });
        // ドラッグ&ドロップ移動
        dot.addEventListener('mousedown', startDrag);
        dot.addEventListener('touchstart', startTouchDrag, { passive: false });
        area.appendChild(dot);
      });
    }

    // ドラッグ&ドロップ（PC）
    document.querySelectorAll('.field-area').forEach(area => {
      area.addEventListener('dragover', e => {
        e.preventDefault();
      });
      area.addEventListener('drop', e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const rect = area.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 1000;
        const y = ((e.clientY - rect.top) / rect.height) * 600;
        movePlayerToField(data.id, area.id, x, y, data.from);
      });
    });

    // ドラッグ&ドロップ（控え・出場停止への移動）
    document.getElementById('players-list').addEventListener('dragover', e => e.preventDefault());
    document.getElementById('players-list').addEventListener('drop', e => {
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      movePlayerToBenchOrSuspended(data.id, data.from, "bench");
    });

    // ドラッグ&ドロップ移動
    function movePlayerToField(id, fieldId, x, y, from) {
      id = Number(id);
      // 既存の場所から削除
      removePlayerFromState(id, from);
      // 新しい場所に追加
      const player = players.find(p => p.id === id);
      playerStates[fieldId][id] = { ...player, x, y, status: "field" };
      renderAll();
    }
    function movePlayerToBenchOrSuspended(id, from, to) {
      id = Number(id);
      removePlayerFromState(id, from);
      const player = players.find(p => p.id === id);
      playerStates[to].push({ ...player, status: to });
      renderAll();
    }
    function removePlayerFromState(id, from) {
      id = Number(id);
      if (from === "field1" || from === "field2") {
        delete playerStates[from][id];
      } else if (from === "bench" || from === "suspended") {
        playerStates[from] = playerStates[from].filter(p => p.id !== id);
      }
    }

    // ドットのドラッグ（PC: mousedown, mousemove, mouseup）
    let dragTarget = null, dragField = null, dragOffset = {x:0, y:0};
    function startDrag(e) {
      if (e.button !== 0) return;
      dragTarget = e.target;
      dragField = dragTarget.closest('.field-area').id;
      const id = Number(dragTarget.dataset.id);
      dragOffset.x = e.offsetX;
      dragOffset.y = e.offsetY;
      document.addEventListener('mousemove', onDragMove);
      document.addEventListener('mouseup', onDragEnd);
    }
    function onDragMove(e) {
      if (!dragTarget) return;
      const area = document.getElementById(dragField);
      const rect = area.getBoundingClientRect();
      let x = ((e.clientX - rect.left - dragOffset.x + 16) / rect.width) * 1000;
      let y = ((e.clientY - rect.top - dragOffset.y + 16) / rect.height) * 600;
      x = Math.max(0, Math.min(1000, x));
      y = Math.max(0, Math.min(600, y));
      const id = Number(dragTarget.dataset.id);
      playerStates[dragField][id].x = x;
      playerStates[dragField][id].y = y;
      renderFieldPlayers(dragField);
    }
    function onDragEnd(e) {
      dragTarget = null;
      dragField = null;
      document.removeEventListener('mousemove', onDragMove);
      document.removeEventListener('mouseup', onDragEnd);
      renderAll();
    }

    // タッチドラッグ（スマホ・タブレット）
    let touchDragTarget = null, touchDragField = null, touchDragId = null;
    function startTouchDrag(e) {
      if (e.touches.length !== 1) return;
      e.preventDefault();
      touchDragTarget = e.target;
      touchDragField = touchDragTarget.closest('.field-area').id;
      touchDragId = Number(touchDragTarget.dataset.id);
      document.addEventListener('touchmove', onTouchDragMove, { passive: false });
      document.addEventListener('touchend', onTouchDragEnd);
    }
    function onTouchDragMove(e) {
      if (!touchDragTarget) return;
      const area = document.getElementById(touchDragField);
      const rect = area.getBoundingClientRect();
      let x = ((e.touches[0].clientX - rect.left) / rect.width) * 1000;
      let y = ((e.touches[0].clientY - rect.top) / rect.height) * 600;
      x = Math.max(0, Math.min(1000, x));
      y = Math.max(0, Math.min(600, y));
      playerStates[touchDragField][touchDragId].x = x;
      playerStates[touchDragField][touchDragId].y = y;
      renderFieldPlayers(touchDragField);
    }
    function onTouchDragEnd(e) {
      touchDragTarget = null;
      touchDragField = null;
      touchDragId = null;
      document.removeEventListener('touchmove', onTouchDragMove);
      document.removeEventListener('touchend', onTouchDragEnd);
      renderAll();
    }

    // コンテキストメニュー
    const menu = document.getElementById('context-menu');
    function showContextMenu(e, player, location, isTouch = false) {
      menu.style.display = 'flex';
      menu.classList.add('active');
      const x = isTouch ? (e.touches ? e.touches[0].clientX : e.clientX) : e.clientX;
      const y = isTouch ? (e.touches ? e.touches[0].clientY : e.clientY) : e.clientY;
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.dataset.id = player.id;
      menu.dataset.location = location;
      // メニューの有効/無効
      menu.querySelector('[data-action="bench"]').disabled = (location === "bench");
      menu.querySelector('[data-action="suspend"]').disabled = (location === "suspended");
      menu.querySelector('[data-action="field"]').disabled = (location === "field1" || location === "field2");
    }
    document.body.addEventListener('click', () => {
      menu.classList.remove('active');
      menu.style.display = 'none';
    });
    menu.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      const id = Number(menu.dataset.id);
      const location = menu.dataset.location;
      if (e.target.dataset.action === "bench") {
        movePlayerToBenchOrSuspended(id, location, "bench");
      } else if (e.target.dataset.action === "suspend") {
        movePlayerToBenchOrSuspended(id, location, "suspended");
      } else if (e.target.dataset.action === "field") {
        // フィールド1に戻す（初期位置）
        const idx = players.findIndex(p => p.id === id);
        if (idx < 11) {
          const pos = formation_4231[idx];
          movePlayerToField(id, "field1", pos.x, pos.y, location);
        } else {
          // 控え選手は控えに戻す
          movePlayerToBenchOrSuspended(id, location, "bench");
        }
      }
      menu.classList.remove('active');
      menu.style.display = 'none';
    });

    // 全体再描画
    function renderAll() {
      renderPlayersList();
      renderFieldPlayers('field1');
      renderFieldPlayers('field2');
    }
    renderAll();
  </script>
</body>
</html>